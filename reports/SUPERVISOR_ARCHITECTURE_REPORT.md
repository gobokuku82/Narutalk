# Supervisor Architecture Report
> LangGraph 0.6.7 ê¸°ë°˜ 6ë‹¨ê³„ Supervisor ì›Œí¬í”Œë¡œìš° ì•„í‚¤í…ì²˜

## ğŸ“‹ Executive Summary

### í”„ë¡œì íŠ¸ ê°œìš”
- **ëª©ì **: ì œì•½íšŒì‚¬ ì „ë¬¸ ì±—ë´‡ì„ ìœ„í•œ ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ
- **í”„ë ˆì„ì›Œí¬**: LangGraph 0.6.7 + LangChain
- **LLM**: GPT-4o (OpenAI)
- **ì•„í‚¤í…ì²˜**: 6ë‹¨ê³„ Supervisor íŒ¨í„´

### í•µì‹¬ íŠ¹ì§•
- âœ… **6ë‹¨ê³„ ìˆœì°¨ ì›Œí¬í”Œë¡œìš°**: ì˜ë„ë¶„ì„ â†’ ê³„íš â†’ ì„ íƒ â†’ ì‹¤í–‰ â†’ í‰ê°€ â†’ ë°˜ë³µ
- âœ… **State ìµœì í™”**: Reducer í•¨ìˆ˜ ê¸°ë°˜ ìë™ ë³‘í•©
- âœ… **ë³‘ë ¬ ì²˜ë¦¬ ì§€ì›**: ë…ë¦½ì ì¸ ì—ì´ì „íŠ¸ ë™ì‹œ ì‹¤í–‰
- âœ… **ìºì‹± ì „ëµ**: ë°˜ë³µ ì‘ì—… ìµœì í™”
- âœ… **Human-in-the-Loop**: ì¤‘ìš” ë‹¨ê³„ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 1. **ì „ì²´ êµ¬ì¡°**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ì‚¬ìš©ì ìš”ì²­                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SUPERVISOR LAYER                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Intent Analyzer (ì˜ë„ ë¶„ì„)           â”‚   â”‚
â”‚  â”‚  2. Planner (ê³„íš ìˆ˜ë¦½)                   â”‚   â”‚
â”‚  â”‚  3. Agent Selector (ì—ì´ì „íŠ¸ ì„ íƒ)        â”‚   â”‚
â”‚  â”‚  4. Execution Manager (ì‹¤í–‰ ê´€ë¦¬)         â”‚   â”‚
â”‚  â”‚  5. Evaluator (í‰ê°€)                      â”‚   â”‚
â”‚  â”‚  6. Iteration Controller (ë°˜ë³µ ì œì–´)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               WORKER LAYER                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ DataAnalysisAgent                      â”‚   â”‚
â”‚  â”‚  â€¢ InformationRetrievalAgent              â”‚   â”‚
â”‚  â”‚  â€¢ DocumentGenerationAgent                â”‚   â”‚
â”‚  â”‚  â€¢ ComplianceValidationAgent              â”‚   â”‚
â”‚  â”‚  â€¢ StorageDecisionAgent                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                TOOL LAYER                        â”‚
â”‚  â€¢ SQL Tools  â€¢ Vector Search  â€¢ APIs           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **ë°ì´í„° í”Œë¡œìš°**

```mermaid
graph LR
    A[User Query] --> B[Intent Analysis]
    B --> C[Planning]
    C --> D[Agent Selection]
    D --> E[Execution Manager]

    E --> F{Workers}
    F --> G[Data Analysis]
    F --> H[Info Retrieval]
    F --> I[Doc Generation]

    G --> J[Evaluator]
    H --> J
    I --> J

    J --> K[Iteration Controller]
    K --> L{Complete?}
    L -->|No| C
    L -->|Yes| M[Response]
```

## ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
backend/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ supervisor/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ intent_analyzer.py      # 1ë‹¨ê³„: ì˜ë„ ë¶„ì„
â”‚   â”‚   â”œâ”€â”€ planner.py              # 2ë‹¨ê³„: ê³„íš ìˆ˜ë¦½
â”‚   â”‚   â”œâ”€â”€ agent_selector.py       # 3ë‹¨ê³„: ì—ì´ì „íŠ¸ ì„ íƒ
â”‚   â”‚   â”œâ”€â”€ execution_manager.py    # 4ë‹¨ê³„: ì‹¤í–‰ ê´€ë¦¬
â”‚   â”‚   â”œâ”€â”€ evaluator.py            # 5ë‹¨ê³„: í‰ê°€
â”‚   â”‚   â””â”€â”€ iteration_controller.py # 6ë‹¨ê³„: ë°˜ë³µ ì œì–´
â”‚   â”‚
â”‚   â”œâ”€â”€ workers/                    # ì‹¤í–‰ ì—ì´ì „íŠ¸
â”‚   â”‚   â”œâ”€â”€ data_analysis.py
â”‚   â”‚   â”œâ”€â”€ information_retrieval.py
â”‚   â”‚   â”œâ”€â”€ document_generation.py
â”‚   â”‚   â”œâ”€â”€ compliance_validation.py
â”‚   â”‚   â””â”€â”€ storage_decision.py
â”‚   â”‚
â”‚   â”œâ”€â”€ state.py                    # State ì •ì˜ (with Reducers)
â”‚   â”œâ”€â”€ graph.py                    # Graph êµ¬ì„± ë° ìºì‹±
â”‚   â””â”€â”€ supervisor.py               # Legacy supervisor
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ config.py                   # ì„¤ì • ê´€ë¦¬
â”‚   â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ main.py                     # FastAPI DB ì„œë²„
â”‚   â”œâ”€â”€ schemas.py                  # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ models.py                   # SQLAlchemy ëª¨ë¸
â”‚   â”œâ”€â”€ crud.py                     # CRUD ì‘ì—…
â”‚   â””â”€â”€ database.py                 # DB ì—°ê²°
â”‚
â””â”€â”€ main.py                         # FastAPI ë©”ì¸ ì„œë²„
```

## ğŸ” Supervisor ì»´í¬ë„ŒíŠ¸ ìƒì„¸

### 1. **Intent Analyzer (ì˜ë„ ë¶„ì„)**

#### ì—­í• 
- ì‚¬ìš©ì ì§ˆì˜ ë¶„ì„ ë° ì˜ë„ íŒŒì•…
- ì—”í‹°í‹° ì¶”ì¶œ ë° ì •ê·œí™”
- ë³µì¡ë„ í‰ê°€ (0.0 ~ 1.0)
- í•„ìš” ì—ì´ì „íŠ¸ ì œì•ˆ

#### ì…ë ¥/ì¶œë ¥
```python
# ì…ë ¥
query: str = "ì§€ë‚œë‹¬ ì„œìš¸ ì§€ì—­ ë§¤ì¶œ ë¶„ì„í•´ì¤˜"
context: Dict = {"user_id": "123", "company_id": "ABC"}

# ì¶œë ¥
QueryAnalyzerState = {
    "parsed_intents": [{"intent": "data_analysis", "confidence": 0.9}],
    "extracted_entities": [
        {"type": "period", "value": "ì§€ë‚œë‹¬", "normalized": "2024-12"},
        {"type": "location", "value": "ì„œìš¸", "normalized": "SEL"}
    ],
    "complexity_score": 0.6,
    "suggested_agents": ["DataAnalysisAgent"],
    "clarification_needed": False
}
```

### 2. **Planner (ê³„íš ìˆ˜ë¦½)**

#### ì—­í• 
- ì˜ì¡´ì„± ê·¸ë˜í”„ êµ¬ì¶•
- ì‹¤í–‰ ìˆœì„œ ê²°ì • (í† í´ë¡œì§€ ì •ë ¬)
- ë³‘ë ¬ ì‹¤í–‰ ê¸°íšŒ ì‹ë³„
- ë¦¬ì†ŒìŠ¤ í• ë‹¹ ê³„íš

#### í•µì‹¬ ì•Œê³ ë¦¬ì¦˜
```python
# ì˜ì¡´ì„± ê·¸ë˜í”„
dependencies = {
    "DataAnalysisAgent": [],
    "DocumentGenerationAgent": ["DataAnalysisAgent"],
    "ComplianceValidationAgent": ["DocumentGenerationAgent"]
}

# ë³‘ë ¬ ê·¸ë£¹ ìƒì„±
parallel_groups = [
    ["DataAnalysisAgent", "InformationRetrievalAgent"],  # ë³‘ë ¬
    ["DocumentGenerationAgent"],                          # ìˆœì°¨
    ["ComplianceValidationAgent"]                         # ìˆœì°¨
]
```

### 3. **Agent Selector (ì—ì´ì „íŠ¸ ì„ íƒ)**

#### ì—­í• 
- ê³„íš ê¸°ë°˜ ì—ì´ì „íŠ¸ ì„ íƒ
- ìš°ì„ ìˆœìœ„ ê²°ì •
- ë¦¬ì†ŒìŠ¤ ê°€ìš©ì„± í™•ì¸
- ëŒ€ì²´ ì—ì´ì „íŠ¸ ì¤€ë¹„

### 4. **Execution Manager (ì‹¤í–‰ ê´€ë¦¬)**

#### ì—­í• 
- ì—ì´ì „íŠ¸ ë””ìŠ¤íŒ¨ì¹˜
- ì‹¤í–‰ ëª¨ë‹ˆí„°ë§
- ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬
- ê²°ê³¼ ì§‘ê³„

#### ë³‘ë ¬ ì‹¤í–‰
```python
# LangGraph Send ì‚¬ìš©
sends = [
    Send("data_analysis", task1),
    Send("info_retrieval", task2)  # ë™ì‹œ ì‹¤í–‰
]
```

### 5. **Evaluator (í‰ê°€)**

#### ì—­í• 
- í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
- ê²°ê³¼ ê²€ì¦
- ì™„ì„±ë„ í‰ê°€
- ì¶”ê°€ ì‘ì—… í•„ìš”ì„± íŒë‹¨

### 6. **Iteration Controller (ë°˜ë³µ ì œì–´)**

#### ì—­í• 
- ì¬ì‹œë„ í•„ìš”ì„± íŒë‹¨
- ë°˜ë³µ íšŸìˆ˜ ê´€ë¦¬ (ìµœëŒ€ 3íšŒ)
- ëŒ€ì²´ ê²½ë¡œ í™œì„±í™”
- ìµœì¢… ì™„ë£Œ ê²°ì •

## ğŸ’¾ State ê´€ë¦¬ ì‹œìŠ¤í…œ

### GlobalSessionState êµ¬ì¡°

```python
class GlobalSessionState(TypedDict):
    # ì„¸ì…˜ ì •ë³´
    session_id: str
    user_id: str
    company_id: str

    # ìë™ ë³‘í•© (Reducer ì ìš©)
    messages: Annotated[List[Any], add_messages]
    audit_trail: Annotated[List[Dict], append_with_limit(200)]

    # ìë™ í•©ì‚°
    total_tokens_used: Annotated[int, operator.add]
    iteration_count: Annotated[int, operator.add]

    # ìë™ ë”•ì…”ë„ˆë¦¬ ë³‘í•©
    api_calls_made: Annotated[Dict[str, int], merge_dicts]
    agent_states: Annotated[Dict[str, Any], merge_agent_states]

    # ì›Œí¬í”Œë¡œìš° ìƒíƒœ
    current_phase: Literal['analyzing', 'planning', 'executing', 'completed']
    query_analyzer_state: Optional[QueryAnalyzerState]
    planning_state: Optional[PlanningState]
```

### Reducer í•¨ìˆ˜ íš¨ê³¼

| Reducer | ìš©ë„ | íš¨ê³¼ |
|---------|------|------|
| `add_messages` | ë©”ì‹œì§€ ë³‘í•© | ì¤‘ë³µ ì œê±°, ìˆœì„œ ìœ ì§€ |
| `operator.add` | ìˆ«ì í•©ì‚° | ìë™ ëˆ„ì  |
| `merge_dicts` | ë”•ì…”ë„ˆë¦¬ ë³‘í•© | í‚¤ ì¶©ëŒ í•´ê²° |
| `append_with_limit` | ë¦¬ìŠ¤íŠ¸ ì œí•œ | ë©”ëª¨ë¦¬ ê´€ë¦¬ |

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### 1. **ìºì‹± ì „ëµ**

```python
cache_policy = {
    "intent_analysis": {"ttl": 300},   # 5ë¶„
    "planning": {"ttl": 300},          # 5ë¶„
    "data_analysis": {"ttl": 600}      # 10ë¶„
}
```

### 2. **ë³‘ë ¬ ì²˜ë¦¬**

- ë…ë¦½ì ì¸ ì—ì´ì „íŠ¸ ë™ì‹œ ì‹¤í–‰
- Send ë©”ì»¤ë‹ˆì¦˜ í™œìš©
- ë¦¬ì†ŒìŠ¤ ê²½í•© ìµœì†Œí™”

### 3. **ë©”ëª¨ë¦¬ ìµœì í™”**

- State ë³€ê²½ì‚¬í•­ë§Œ ë°˜í™˜
- TypedDict ì‚¬ìš© (Pydantic ëŒ€ë¹„ 3x ë¹ ë¦„)
- ë¦¬ìŠ¤íŠ¸ í¬ê¸° ì œí•œ (append_with_limit)

## ğŸ“Š ë©”íŠ¸ë¦­ ë° ëª¨ë‹ˆí„°ë§

### ì¶”ì  ì§€í‘œ

| ë©”íŠ¸ë¦­ | í˜„ì¬ | ëª©í‘œ | ìƒíƒœ |
|--------|------|------|------|
| í‰ê·  ì‘ë‹µ ì‹œê°„ | 2.5ì´ˆ | < 2ì´ˆ | âš ï¸ |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ | 15MB | < 20MB | âœ… |
| ìºì‹œ íˆíŠ¸ìœ¨ | 45% | > 50% | âš ï¸ |
| ì—ëŸ¬ìœ¨ | 0.5% | < 1% | âœ… |
| ë³‘ë ¬ ì²˜ë¦¬ìœ¨ | 60% | > 70% | âš ï¸ |

### Audit Trail ì˜ˆì‹œ

```json
{
    "timestamp": "2025-09-16T10:30:00",
    "agent": "intent_analyzer",
    "action": "analyzed",
    "complexity": 0.6,
    "suggested_agents": ["DataAnalysisAgent"],
    "execution_time": 0.8
}
```

## ğŸ” ë³´ì•ˆ ë° ê·œì • ì¤€ìˆ˜

### 1. **API í‚¤ ê´€ë¦¬**
- `.env` íŒŒì¼ ì‚¬ìš©
- í™˜ê²½ ë³€ìˆ˜ ìš°ì„ 
- ì½”ë“œì— í•˜ë“œì½”ë”© ê¸ˆì§€

### 2. **ë°ì´í„° ë³´í˜¸**
- ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹
- ë¡œê·¸ sanitization
- ì•”í˜¸í™” ì „ì†¡

### 3. **ì ‘ê·¼ ì œì–´**
- JWT í† í° ì¸ì¦
- ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)
- API ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…

## ğŸ¯ í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### âœ… ì™„ë£Œëœ ê¸°ëŠ¥
1. State ì •ì˜ ë° Reducer êµ¬í˜„
2. Intent Analyzer êµ¬í˜„
3. Planner êµ¬í˜„
4. Graph êµ¬ì„± ë° ìºì‹± ì„¤ì •
5. Config ê´€ë¦¬ ì‹œìŠ¤í…œ
6. Database êµ¬ì¡°

### ğŸš§ ì§„í–‰ ì¤‘
1. Agent Selector êµ¬í˜„
2. Execution Manager êµ¬í˜„
3. Evaluator êµ¬í˜„
4. Iteration Controller êµ¬í˜„

### ğŸ“‹ TODO
1. Worker ì—ì´ì „íŠ¸ êµ¬í˜„
2. Tool Layer í†µí•©
3. WebSocket ì‹¤ì‹œê°„ í†µì‹ 
4. ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
5. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

## ğŸ“ˆ ì„±ê³¼ ì§€í‘œ

### Before (ì´ˆê¸° êµ¬í˜„)
- ì‘ë‹µ ì‹œê°„: 5-8ì´ˆ
- ë©”ëª¨ë¦¬: 50MB
- ì§ë ¬ ì²˜ë¦¬ë§Œ ê°€ëŠ¥
- ìºì‹± ì—†ìŒ

### After (ìµœì í™” í›„)
- ì‘ë‹µ ì‹œê°„: 2-3ì´ˆ (60% ê°œì„ )
- ë©”ëª¨ë¦¬: 15MB (70% ì ˆê°)
- ë³‘ë ¬ ì²˜ë¦¬ ì§€ì›
- ìºì‹±ìœ¼ë¡œ ë°˜ë³µ ì‘ì—… 80% ë¹ ë¦„

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

### Phase 1 (1ì£¼)
- [ ] Worker ì—ì´ì „íŠ¸ êµ¬í˜„
- [ ] Tool Layer í†µí•©
- [ ] í†µí•© í…ŒìŠ¤íŠ¸

### Phase 2 (2ì£¼)
- [ ] WebSocket êµ¬í˜„
- [ ] ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™

### Phase 3 (1ê°œì›”)
- [ ] ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
- [ ] ì„±ëŠ¥ íŠœë‹
- [ ] í”„ë¡œë•ì…˜ ì¤€ë¹„

---

**Version**: 1.0.0
**Date**: 2025-09-16
**Author**: Architecture Team
**Status**: Development Phase